name: "Build Multi-Arch Manifest"
description: "Creates a multi-architecture image manifest from per-arch images"

inputs:
  registry:
    description: "Container registry URL (e.g., ghcr.io)"
    required: true
  org:
    description: "Organization or namespace in the registry (e.g., hydn-co)"
    required: true
  app:
    description: "Application name (e.g., authd, brokerd, streamd, apigwd, workerd)"
    required: true
  semver:
    description: "Semantic version tag (e.g., v1.2.3)"
    required: true
  wait-for-images:
    description: "Maximum seconds to wait for arch images to become available (0 = no wait)"
    required: false
    default: "300"

outputs:
  manifest:
    description: "Full image reference for the created manifest (registry/org/app:tag)"
    value: ${{ steps.manifest.outputs.manifest }}
  digest:
    description: "Manifest digest (sha256:...)"
    value: ${{ steps.manifest.outputs.digest }}
  architectures:
    description: "Comma-separated list of architectures in manifest"
    value: ${{ steps.manifest.outputs.architectures }}

runs:
  using: "composite"
  steps:
    - name: Create Multi-Arch Manifest For ${{ inputs.app }}
      id: manifest
      shell: bash
      env:
        SEMVER: ${{ inputs.semver }}
        IMAGE: ${{ inputs.registry }}/${{ inputs.org }}/mesh-${{ inputs.app }}
      run: |
        set -euo pipefail

        # Validate semver format
        echo "ÔøΩ Validating inputs..."
        if [[ ! "$SEMVER" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
          echo "‚ùå ERROR: Invalid semver format '$SEMVER'. Expected format: v1.2.3"
          exit 1
        fi

        echo "ÔøΩüîó Checking multi-arch manifest for $IMAGE:$SEMVER"

        # If manifest already exists, exit early
        if docker manifest inspect "$IMAGE:$SEMVER" >/dev/null 2>&1; then
          echo "‚úÖ Manifest already exists: $IMAGE:$SEMVER"
          echo "manifest=$IMAGE:$SEMVER" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        # Verify both architecture images exist
        echo "üîç Verifying architecture-specific images exist..."
        missing_arches=()
        for arch in amd64 arm64; do
          if docker buildx imagetools inspect "$IMAGE:$SEMVER-$arch" >/dev/null 2>&1; then
            echo "‚úÖ Found $IMAGE:$SEMVER-$arch"
          else
            echo "‚ùå Missing $IMAGE:$SEMVER-$arch"
            missing_arches+=("$arch")
          fi
        done

        # Create manifest if all images exist
        if [ ${#missing_arches[@]} -eq 0 ]; then
          echo "üöÄ Creating multi-arch manifest $IMAGE:$SEMVER"
          
          if ! docker buildx imagetools create \
            --tag "$IMAGE:$SEMVER" \
            "$IMAGE:$SEMVER-amd64" \
            "$IMAGE:$SEMVER-arm64"; then
            echo "‚ùå ERROR: Failed to create manifest"
            echo "   Target: $IMAGE:$SEMVER"
            echo "   Sources:"
            echo "     - $IMAGE:$SEMVER-amd64"
            echo "     - $IMAGE:$SEMVER-arm64"
            exit 1
          fi
          
          echo "‚úÖ Manifest created: $IMAGE:$SEMVER"
          echo "manifest=$IMAGE:$SEMVER" >> "$GITHUB_OUTPUT"
        else
          echo "‚ùå ERROR: Cannot create manifest - missing architecture image(s)"
          echo "   Missing: ${missing_arches[*]}"
          echo "   Expected images:"
          echo "     - $IMAGE:$SEMVER-amd64"
          echo "     - $IMAGE:$SEMVER-arm64"
          echo ""
          echo "   Ensure the build job completed successfully for all architectures."
          exit 1
        fi
