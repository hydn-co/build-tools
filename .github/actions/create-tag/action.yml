name: "Create Git Tag"
description: "Creates an annotated Git tag for a release. Idempotent - safe to run if tag already exists."

inputs:
  semver:
    description: "Semantic version tag to create (e.g., v0.1.0 or 0.1.0). Normalized to always use leading 'v' (e.g. v0.1.0)."
    required: true
  message:
    description: "Tag annotation message (defaults to 'Release {semver}')"
    required: false
    default: ""
  push:
    description: "Whether to push the tag to remote (true/false)"
    required: false
    default: "true"

outputs:
  tag:
    description: "The tag name that was created or already existed"
    value: ${{ steps.tag.outputs.tag }}
  created:
    description: "Whether the tag was newly created (true) or already existed (false)"
    value: ${{ steps.tag.outputs.created }}
  commit:
    description: "The commit SHA the tag points to"
    value: ${{ steps.tag.outputs.commit }}

runs:
  using: "composite"
  steps:
    - name: Create and Push Git Tag
      id: tag
      shell: bash
      env:
        SEMVER: ${{ inputs.semver }}
        MESSAGE: ${{ inputs.message }}
        PUSH: ${{ inputs.push }}
      run: |
        set -euo pipefail

        # Ensure Git identity is set (required for annotated tags on runners without default config)
        git config user.name "hydn-co"
        git config user.email "hydn-co@hydden.com"

        # Validate inputs
        echo "ðŸ” Validating inputs..."
        # Accept semver with optional leading 'v' and optional prerelease/build metadata
        if [[ ! "$SEMVER" =~ ^v?(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-([0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*))?(\+([0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*))?$ ]]; then
          echo "âŒ ERROR: Invalid semver format '$SEMVER'. Expected a semantic version like 'v1.2.3' or '1.2.3-alpha.1'"
          exit 1
        fi

        if [[ ! "$PUSH" =~ ^(true|false)$ ]]; then
          echo "âŒ ERROR: Invalid push value '$PUSH'. Must be 'true' or 'false'."
          exit 1
        fi

        # Normalize tag to always have leading 'v' (e.g. v0.1.0)
        if [[ "$SEMVER" != v* ]]; then
          SEMVER="v$SEMVER"
          echo "ðŸ“Œ Normalized tag to $SEMVER"
        fi

        # Determine tag message
        if [[ -z "$MESSAGE" ]]; then
          TAG_MESSAGE="Release $SEMVER"
        else
          TAG_MESSAGE="$MESSAGE"
        fi

        # Get current commit
        CURRENT_COMMIT=$(git rev-parse HEAD)
        echo "ðŸ“ Current commit: $CURRENT_COMMIT"

        # Check if tag already exists
        echo "ðŸ” Checking if tag '$SEMVER' exists..."

        # Fetch tags from remote to ensure we have the latest
        if [[ "$PUSH" == "true" ]]; then
          echo "ðŸ“¥ Fetching tags from remote..."
          git fetch --tags --quiet || echo "âš ï¸  Could not fetch tags (may be first time)"
        fi

        if git rev-parse "$SEMVER" >/dev/null 2>&1; then
          # Tag exists - check where it points
          EXISTING_COMMIT=$(git rev-parse "$SEMVER^{commit}")
          
          echo "âœ… Tag '$SEMVER' already exists"
          echo "   Points to: $EXISTING_COMMIT"
          
          if [[ "$EXISTING_COMMIT" != "$CURRENT_COMMIT" ]]; then
            echo ""
            echo "âš ï¸  WARNING: Tag points to different commit than HEAD"
            echo "   Tag commit:     $EXISTING_COMMIT"
            echo "   Current commit: $CURRENT_COMMIT"
            echo ""
            echo "   This is not an error - tag will not be moved."
            echo "   If you need to re-tag, delete the existing tag first:"
            echo "   git tag -d $SEMVER"
            echo "   git push origin :refs/tags/$SEMVER"
          fi
          
          # Set outputs
          echo "tag=$SEMVER" >> "$GITHUB_OUTPUT"
          echo "created=false" >> "$GITHUB_OUTPUT"
          echo "commit=$EXISTING_COMMIT" >> "$GITHUB_OUTPUT"
        else
          # Tag doesn't exist - create it
          echo "ðŸ·ï¸  Creating annotated tag '$SEMVER'"
          echo "   Message: $TAG_MESSAGE"
          echo "   Commit: $CURRENT_COMMIT"
          
          if ! git tag -a "$SEMVER" -m "$TAG_MESSAGE"; then
            echo "âŒ ERROR: Failed to create tag '$SEMVER'"
            echo "   Commit: $CURRENT_COMMIT"
            echo "   Message: $TAG_MESSAGE"
            exit 1
          fi
          
          echo "âœ… Tag created successfully"
          
          # Push tag if requested
          if [[ "$PUSH" == "true" ]]; then
            echo "ðŸ“¤ Pushing tag to remote..."
            
            # Retry logic for push (3 attempts)
            MAX_ATTEMPTS=3
            ATTEMPT=1
            
            while [[ $ATTEMPT -le $MAX_ATTEMPTS ]]; do
              echo "ðŸ“¤ Push attempt $ATTEMPT/$MAX_ATTEMPTS..."
              
              if git push origin "$SEMVER"; then
                echo "âœ… Tag pushed to remote successfully"
                break
              else
                if [[ $ATTEMPT -lt $MAX_ATTEMPTS ]]; then
                  echo "âš ï¸  Push failed, retrying in 5 seconds..."
                  sleep 5
                  ((ATTEMPT++))
                else
                  echo "âŒ ERROR: Failed to push tag after $MAX_ATTEMPTS attempts"
                  echo "   Tag: $SEMVER"
                  echo "   You can manually push later with:"
                  echo "   git push origin $SEMVER"
                  exit 1
                fi
              fi
            done
          else
            echo "â­ï¸  Skipping push (push=false)"
          fi
          
          # Set outputs
          echo "tag=$SEMVER" >> "$GITHUB_OUTPUT"
          echo "created=true" >> "$GITHUB_OUTPUT"
          echo "commit=$CURRENT_COMMIT" >> "$GITHUB_OUTPUT"
        fi

        echo ""
        echo "ðŸ“Š Summary:"
        echo "   Tag: $SEMVER"
        echo "   Commit: $(git rev-parse "$SEMVER^{commit}")"
        echo "   Message: $(git tag -l --format='%(contents:subject)' "$SEMVER")"
