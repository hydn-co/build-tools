name: "Deploy Bicep Template"
description: "Deploys Azure Bicep template using subscription-scoped deployment"

inputs:
  environment:
    description: "Target environment name (e.g., dev1, prod1)"
    required: true
  name:
    description: "Deployment name (will be suffixed with environment)"
    required: true
  semver:
    description: "Semantic version to deploy (e.g., v1.2.3 or 1.2.3-alpha.1). Leading 'v' is optional."
    required: true
  applyCerts:
    description: "Whether to apply certificates (true/false)"
    required: false
    default: "false"
  location:
    description: "Azure region for deployment metadata"
    required: false
    default: "eastus"
  template:
    description: "Path to Bicep template file"
    required: false
    default: "./.deploy/bicep/main.bicep"
  parameters:
    description: "Path to Bicep parameters file (will append environment if not full path)"
    required: false
    default: "./.deploy/bicep/params"
  verify-deployment:
    description: "Whether to verify deployment status after completion (true/false)"
    required: false
    default: "true"

outputs:
  deployment-name:
    description: "Full deployment name used"
    value: ${{ steps.deploy.outputs.deployment-name }}
  deployment-id:
    description: "Azure deployment resource ID"
    value: ${{ steps.deploy.outputs.deployment-id }}
  provisioning-state:
    description: "Deployment provisioning state (Succeeded/Failed)"
    value: ${{ steps.deploy.outputs.provisioning-state }}

runs:
  using: "composite"
  steps:
    - name: Deploy Bicep Template
      id: deploy
      shell: bash
      env:
        NAME: ${{ inputs.name }}-${{ inputs.environment }}
        LOCATION: ${{ inputs.location }}
        TEMPLATE: ${{ inputs.template }}
        PARAMETERS: ${{ inputs.parameters }}
        ENVIRONMENT: ${{ inputs.environment }}
        APPLY_CERTS: ${{ inputs.applyCerts }}
        SEMVER: ${{ inputs.semver }}
        VERIFY_DEPLOYMENT: ${{ inputs.verify-deployment }}
      run: |
        set -euo pipefail

        # Validate inputs
        echo "ðŸ” Validating inputs..."
        # Accept semver with optional leading 'v' and optional prerelease/build metadata
        if [[ ! "$SEMVER" =~ ^v?(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(-([0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*))?(\+([0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*))?$ ]]; then
          echo "âŒ ERROR: Invalid semver format '$SEMVER'. Expected a semantic version like 'v1.2.3' or '1.2.3-alpha.1'"
          exit 1
        fi

        if [[ ! "$APPLY_CERTS" =~ ^(true|false)$ ]]; then
          echo "âŒ ERROR: Invalid applyCerts value '$APPLY_CERTS'. Must be 'true' or 'false'."
          exit 1
        fi

        if [[ ! "$VERIFY_DEPLOYMENT" =~ ^(true|false)$ ]]; then
          echo "âŒ ERROR: Invalid verify-deployment value '$VERIFY_DEPLOYMENT'. Must be 'true' or 'false'."
          exit 1
        fi

        # Verify Azure CLI is logged in
        echo "ðŸ” Verifying Azure CLI authentication..."
        if ! az account show >/dev/null 2>&1; then
          echo "âŒ ERROR: Not logged in to Azure CLI"
          echo "   Run 'az login' or ensure OIDC authentication is configured."
          exit 1
        fi

        SUBSCRIPTION=$(az account show --query name -o tsv)
        SUBSCRIPTION_ID=$(az account show --query id -o tsv)
        echo "âœ… Authenticated to subscription: $SUBSCRIPTION"

        # Determine parameters file path
        if [[ "$PARAMETERS" == *.bicepparam ]]; then
          PARAMS_FILE="$PARAMETERS"
        else
          PARAMS_FILE="${PARAMETERS}/${ENVIRONMENT}.bicepparam"
        fi

        # Verify template file exists
        if [[ ! -f "$TEMPLATE" ]]; then
          echo "âŒ ERROR: Bicep template not found at $TEMPLATE"
          echo "   Current directory: $(pwd)"
          ls -la .deploy/bicep/ 2>/dev/null || echo "   .deploy/bicep/ directory not found"
          exit 1
        fi

        # Verify parameters file exists
        if [[ ! -f "$PARAMS_FILE" ]]; then
          echo "âŒ ERROR: Parameters file not found at $PARAMS_FILE"
          echo "   Available parameter files:"
          ls -la "${PARAMETERS}/" 2>/dev/null || echo "   ${PARAMETERS}/ directory not found"
          exit 1
        fi

        echo "ðŸš€ Deploying Bicep template"
        echo "  Name: $NAME"
        echo "  Location: $LOCATION"
        echo "  Template: $TEMPLATE"
        echo "  Parameters: $PARAMS_FILE"
        echo "  Version: $SEMVER"
        echo "  Apply Certs: $APPLY_CERTS"

        if ! az deployment sub create \
          --name "$NAME" \
          --location "$LOCATION" \
          --template-file "$TEMPLATE" \
          --parameters "$PARAMS_FILE" \
            applyCerts="$APPLY_CERTS" \
            semver="$SEMVER"; then
          echo ""
          echo "âŒ ERROR: Bicep deployment failed"
          echo "   Deployment name: $NAME"
          echo "   Location: $LOCATION"
          echo "   Template: $TEMPLATE"
          echo "   Parameters: $PARAMS_FILE"
          echo ""
          echo "   Check the Azure Portal for detailed error messages:"
          echo "   https://portal.azure.com/#view/HubsExtension/DeploymentDetailsBlade/~/overview/id/%2Fsubscriptions%2F$SUBSCRIPTION_ID%2Fproviders%2FMicrosoft.Resources%2Fdeployments%2F$NAME"
          exit 1
        fi

        # Get deployment details
        DEPLOYMENT_ID="/subscriptions/$SUBSCRIPTION_ID/providers/Microsoft.Resources/deployments/$NAME"

        # Set outputs
        echo "deployment-name=$NAME" >> "$GITHUB_OUTPUT"
        echo "deployment-id=$DEPLOYMENT_ID" >> "$GITHUB_OUTPUT"

        # Verify deployment if requested
        if [[ "$VERIFY_DEPLOYMENT" == "true" ]]; then
          echo ""
          echo "ðŸ” Verifying deployment status..."
          
          PROVISIONING_STATE=$(az deployment sub show \
            --name "$NAME" \
            --query properties.provisioningState \
            -o tsv 2>/dev/null || echo "Unknown")
          
          echo "provisioning-state=$PROVISIONING_STATE" >> "$GITHUB_OUTPUT"
          
          if [[ "$PROVISIONING_STATE" == "Succeeded" ]]; then
            echo "âœ… Deployment verified: $PROVISIONING_STATE"
            
            # Show deployment outputs if any
            OUTPUTS=$(az deployment sub show \
              --name "$NAME" \
              --query properties.outputs \
              -o json 2>/dev/null || echo "{}")
            
            if [[ "$OUTPUTS" != "{}" ]]; then
              echo ""
              echo "ðŸ“¤ Deployment outputs:"
              echo "$OUTPUTS" | jq '.'
            fi
          else
            echo "âš ï¸  Warning: Deployment state is $PROVISIONING_STATE"
          fi
        else
          echo "provisioning-state=NotVerified" >> "$GITHUB_OUTPUT"
        fi

        echo "âœ… Deployment completed successfully"
